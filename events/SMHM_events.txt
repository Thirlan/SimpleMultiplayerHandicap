namespace = smhm

# Send every player, Test your might event
event = {
	id = smhm.1
	hide_window = yes

	is_triggered_only = yes
    
    immediate = {
        every_playable_country = {
            limit = {
                is_ai = no
            }
            country_event = {
                id = smhm.2
            }
        }
    }
}

# Test your might
country_event = {
	id = smhm.2
	title = smhm.2.name
	desc = smhm.2.desc
	
	picture = GFX_evt_gladiators
	show_sound = event_default
	
	is_triggered_only = yes
	
	immediate = {
		owner = {
			country_event = {
				id = smhm.3 days = 60
			}
		}
	}

	option = {
		name = smhm.2.a
        add_modifier = {
            modifier = weak_handicap
            days = -1
        }
        save_event_target_as = smhm_handicap_country
		every_playable_country = {
            country_event = {
                id = smhm.4
            }
        }
	}
	option = {
		name = smhm.2.b
	}
	option = {
		name = smhm.2.c
        add_modifier = {
            modifier = strong_handicap
            days = -1
        }
        save_event_target_as = smhm_handicap_country
        every_playable_country = {
            country_event = {
                id = smhm.4
            }
        }
	}
}

# Confirm your might
country_event = {
	id = smhm.3
	title = smhm.3.name

	desc = {
		text = smhm.3.desc_01
		trigger = {
			 has_modifier = weak_handicap
		}
	}
	
	desc = {
		text = smhm.3.desc_02
		trigger = {
			 has_modifier = strong_handicap
		}
	}
	
	picture = GFX_evt_gladiators
	show_sound = event_default
	
	is_triggered_only = yes

	option = {
		name = smhm.3.a
	}

	option = {
		name = smhm.3.b
		remove_modifier = weak_handicap
        remove_modifier = strong_handicap
	}
}

# Declare your might
country_event = {
	id = smhm.4
	title = smhm.4.name

	desc = {
		text = smhm.4.desc_01
		trigger = {
			event_target:smhm_handicap_country = {
                has_modifier = weak_handicap
            }
		}
	}
	
	desc = {
		text = smhm.4.desc_02
		trigger = {
            event_target:smhm_handicap_country = {
                has_modifier = strong_handicap
            }
		}
	}
	
	picture = GFX_evt_alien_propaganda
	show_sound = event_default
	
	is_triggered_only = yes

	option = {
		name = smhm.4.a
	}
}

# Blessings of the Underdog
event = {
	id = smhm.5
	hide_window = yes

	is_triggered_only = yes
    
	immediate = {
        log = "Finding Weakest Player"
        
        # Find if a player already has the blessing_of_the_underdog
        every_playable_country = {
            limit = {
                is_ai = no
                has_modifier = blessing_of_the_underdog
            }
            log = "[owner.GetName] currently has the blessing_of_the_underdog"
            save_event_target_as = smhm_blessed_player
        }
        
        # Pick a random country to start the algorithm
        random_playable_country = {
            limit = {
                is_ai = no
            }
            log = "randomly starting with [owner.GetName] as weakest"
            save_event_target_as = smhm_weakest_player
        }
        
        # Find the weakest player
        every_playable_country = {
            limit = {
                is_ai = no
                NOT = {
                    is_same_empire = event_target:smhm_weakest_player
                }
            }
            log = "comparing with [owner.GetName]"
            
            if = {
                limit = {
                    relative_power = {
                        who = event_target:smhm_weakest_player
                        category = all
                        value < equivalent
                    }
                }
                log = "[owner.GetName] is weaker than [smhm_weakest_player.GetName]"
                save_event_target_as = smhm_weakest_player
            }
        }
        
        # Let's now determine if we truly have a weak player.
        # If they are weak there should be NO player equivalent to them
        every_playable_country = {
            limit = {
                is_ai = no
                NOT = {
                    is_same_empire = event_target:smhm_weakest_player
                }
            }
            log = "comparing with [owner.GetName]"
            
            if = {
                limit = {
                    relative_power = {
                        who = event_target:smhm_weakest_player
                        category = all
                        value = equivalent
                    }
                }
                log = "[owner.GetName] is equivalent to [smhm_weakest_player.GetName]"
                save_event_target_as = smhm_equal_to_weakest_player
            }
        }
        
        # We now have the following information:
        # smhm_blessed_player (if any)
        # smhm_weakest_player
        # smhm_equal_to_weakest_player (if any)
        #
        # These extra pieces of information are critical because
        # the comparison is not granular enough to determine true
        # weakest
        
        # First and foremost, does someone have the blessing
        if = {
            limit = {
                exists = event_target:smhm_blessed_player
            }
            
            # Someone has the blessing. Are they still the weakest player?
            if = {
                limit = {
                    event_target:smhm_blessed_player = {
                        is_same_empire = event_target:smhm_weakest_player
                    }
                }
                
                # They still appear to be the weakest, but are they truly weak?
                # Check if there is anyone equal to them
                if = {
                    limit = {
                        exists = event_target:smhm_equal_to_weakest_player
                    }
                    
                    # There exists someone equal to them. They are no longer truly
                    # weak. Strip them of their powers
                    event_target:smhm_blessed_player = {
                        country_event = {
                            id = smhm.7
                        }
                    }
                }
            }
            else {
                # The player with the blessing is no longer the weakest
                # strip them of the blessing
                event_target:smhm_blessed_player = {
                    country_event = {
                        id = smhm.7
                    }
                }
                
                # There is a new weak player, but are they truly weak?
                # Check if there is anyone equal to them
                if = {
                    limit = {
                        exists = event_target:smhm_equal_to_weakest_player
                    }
                    # someone is equal to them, do nothing
                }
                else {
                    # They are truly the weakest
                    event_target:smhm_weakest_player = {
                        country_event = {
                            id = smhm.6
                        }
                    }
                }
            }
        }
        else {
            # No one has the blessing but there is a new weak player.
            # Are they truly weak? Check if there is anyone equal to them
            if = {
                limit = {
                    exists = event_target:smhm_equal_to_weakest_player
                }
                # someone is equal to them, do nothing
            }
            else {
                # They are truly the weakest
                event_target:smhm_weakest_player = {
                    country_event = {
                        id = smhm.6
                    }
                }
            }
        }
	}
}

# Blessings of the Underdog given
country_event = {
	id = smhm.6
	title = smhm.6.name
	desc = smhm.6.desc
	
	picture = GFX_evt_open_revolt
	show_sound = event_default
	
	is_triggered_only = yes
    
    immediate = {
        log = "New Weakest [owner.GetName]"
    }

	option = {
		name = smhm.6.a
        add_modifier = {
            modifier = blessing_of_the_underdog
            days = -1
        }
	}
}

# Blessings of the Underdog fades
country_event = {
	id = smhm.7
	title = smhm.7.name
	desc = smhm.7.desc
	
	picture = GFX_evt_announcement
	show_sound = event_default
	
	is_triggered_only = yes

    immediate = {
        remove_modifier = blessing_of_the_underdog
        log = "No longer weakest [owner.GetName]"
    }

	option = {
		name = smhm.7.a
	}
}

# Strongest Player
event = {
	id = smhm.8
	hide_window = yes

	is_triggered_only = yes
    
	immediate = {
        log = "Finding Strongest Player"
        
        # Find if a player already has the curse_of_icarus
        every_playable_country = {
            limit = {
                is_ai = no
                has_modifier = curse_of_icarus
            }
            log = "[owner.GetName] currently has the curse_of_icarus"
            save_event_target_as = smhm_cursed_player
        }
        
        # Pick a random player to start the algorithm
        random_playable_country = {
            limit = {
                is_ai = no
            }
            log = "randomly starting with [owner.GetName] as strongest"
            save_event_target_as = smhm_strongest_player
            save_event_target_as = smhm_strongest_country
        }
        
        # Find the strongest player
        every_playable_country = {
            limit = {
                is_ai = no
                NOT = {
                    is_same_empire = event_target:smhm_strongest_country
                }
            }
            log = "comparing with [owner.GetName]"
            
            if = {
                limit = {
                    relative_power = {
                        who = event_target:smhm_strongest_player
                        category = all
                        value > equivalent
                    }
                }
                log = "[owner.GetName] is stronger than [smhm_strongest_player.GetName]"
                save_event_target_as = smhm_strongest_player
                save_event_target_as = smhm_strongest_country
            }
        }
        
        # Let's now determine if we truly have a strong player.
        # If they are strong there should be NO COUNTRY equivalent to them
        every_playable_country = {
            limit = {
                NOT = {
                    is_same_empire = event_target:smhm_strongest_player
                }
            }
            log = "comparing with [owner.GetName]"
            
            if = {
                limit = {
                    relative_power = {
                        who = event_target:smhm_strongest_player
                        category = all
                        value = equivalent
                    }
                }
                log = "[owner.GetName] is equivalent to [smhm_strongest_player.GetName]"
                save_event_target_as = smhm_equal_to_strongest_player
            }
        }
        
        # Find the strongest country (not necessarily a player)
        every_playable_country = {
            limit = {
                NOT = {
                    is_same_empire = event_target:smhm_strongest_country
                }
            }
            log = "comparing with [owner.GetName]"
            
            if = {
                limit = {
                    relative_power = {
                        who = event_target:smhm_strongest_country
                        category = all
                        value > equivalent
                    }
                }
                log = "[owner.GetName] is stronger than [smhm_strongest_country.GetName]"
                save_event_target_as = smhm_strongest_country
            }
        }
        
        # We now have the following information:
        #
        # smhm_cursed_player (if any)
        # smhm_strongest_player
        # smhm_equal_to_strongest_player (if any)
        # smhm_strongest_country
        #
        # These extra pieces of information are critical because
        # the comparison is not granular enough to determine true
        # stongest
        
        # First and foremost, does someone have the curse?
        if = {
            limit = {
                exists = event_target:smhm_cursed_player
            }
            
            # Someone has the curse. Are they still the strongest country?
            if = {
                limit = {
                    event_target:smhm_cursed_player = {
                        is_same_empire = event_target:smhm_strongest_country
                    }
                }
                
                # They still appear to be the strongest, but are they truly strong?
                # Check if there is anyone equal to them
                if = {
                    limit = {
                        exists = event_target:smhm_equal_to_strongest_player
                    }
                    
                    # There exists someone equal to them. They are no longer truly
                    # strong. Strip them of their curse
                    event_target:smhm_cursed_player = {
                        country_event = {
                            id = smhm.10
                        }
                    }
                }
            }
            else {
                # The player with the curse is no longer the strongest
                # Strip them of their curse
                event_target:smhm_cursed_player = {
                    remove_modifier = curse_of_icarus
                    country_event = {
                        id = smhm.10
                    }
                }
                
                # There is a new strong player, but are they truly strong?
                # Check if they are the strongest of all countries
                if = {
                    limit = {
                        event_target:smhm_strongest_player = {
                            is_same_empire = event_target:smhm_strongest_country
                        }
                    }
                    
                    # Is there anyone equal to them?
                    if = {
                        limit = {
                            exists = event_target:smhm_equal_to_strongest_player
                        }
                        
                        # Someone was equal to them. Do nothing
                    }
                    else {
                        # They are truly the strongest
                        event_target:smhm_strongest_player = {
                            country_event = {
                                id = smhm.9
                            }
                        }
                    }
                }
                else {
                    # There was a stronger country than them
                }
            }
        }
        else {
            # There is a new strong player, but are they truly strong?
            # Check if they are the strongest of all countries
            if = {
                limit = {
                    event_target:smhm_strongest_player = {
                        is_same_empire = event_target:smhm_strongest_country
                    }
                }
                
                # Is there anyone equal to them?
                if = {
                    limit = {
                        exists = event_target:smhm_equal_to_strongest_player
                    }
                    
                    # Someone was equal to them. Do nothing
                }
                else {
                    # They are truly the strongest
                    event_target:smhm_strongest_player = {
                        country_event = {
                            id = smhm.9
                        }
                    }
                }
            }
            else {
                # There was a stronger country than them
            }
        }
	}
}

# Icarus' curse
country_event = {
	id = smhm.9
	title = smhm.9.name
	desc = smhm.9.desc
	
	picture = GFX_evt_atmospheric_flight
	show_sound = event_default
	
	is_triggered_only = yes

    immediate = {
        log = "New Strongest [owner.GetName]"
    }

	option = {
		name = smhm.9.a
        add_modifier = {
            modifier = curse_of_icarus
            days = -1
        }
	}
}

# Icarus' curse fades
country_event = {
	id = smhm.10
	title = smhm.10.name
	desc = smhm.10.desc
	
	picture = GFX_evt_atmospheric_flight
	show_sound = event_default
	
	is_triggered_only = yes

    immediate = {
        remove_modifier = curse_of_icarus
        log = "No longer strongest [owner.GetName]"
    }

	option = {
		name = smhm.10.a
	}
}

